(()=>{"use strict";function e(e){this.sound=document.createElement("audio"),this.sound.src=e,this.sound.setAttribute("preload","auto"),this.sound.setAttribute("controls","none"),this.sound.style.display="none",document.body.appendChild(this.sound),this.play=function(){this.sound.play()},this.stop=function(){this.sound.pause()}}let t={rowsCount:5,colsCount:5,beings:["zouwu","swooping","salamander","puffskein","kelpie"],minLength:3,numberOfMoves:10,beingsForWin:{zouwu:13,kelpie:5},score:0},s={cells:{},movesObj:null,scoreObj:null,gameResultObj:null,renderMap(){let e=document.getElementById("map");e.innerHTML="";for(let s=0;s<t.rowsCount;s++){let n=document.createElement("tr");n.classList.add("row"),e.appendChild(n);for(let e=0;e<t.colsCount;e++){let t=document.createElement("td");t.classList.add("cell"),n.appendChild(t),this.cells[`x${s}_y${e}`]=t}}},renderBeings(){for(let e in this.cells)if(!this.cells[e].dataset.being){let s=t.beings[Math.floor(Math.random()*t.beings.length)];this.addBeingToCell(s,e)}},addBeingToCell(e,t){let s=document.createElement("img");s.dataset.coords=t,s.src=`images/${e}.png`,this.cells[t].appendChild(s),this.cells[t].dataset.being=e;let n=document.createElement("div");this.cells[t].appendChild(n)},setSelectedCell(e){this.cells[e].classList.add("selected")},resetCell(e){this.cells[e].classList.remove("selected")},clearCell(e){e.innerHTML="",e.dataset.being=""},checkMatchesInMap(){let e=this.checkAndDeleteLinesForMatch(),t=this.checkAndDeleteLinesForMatch(!0);return e||t},checkAndDeleteLinesForMatch(e){let s=!1,n=[],i=this;function l(){return n.length>=t.minLength&&(i.deleteGroup(n),s=!0,!0)}for(let s=0;s<t.rowsCount;s++){let i="";n=[];for(let a=0;a<t.colsCount;a++){let o=e?this.cells[`x${a}_y${s}`]:this.cells[`x${s}_y${a}`];i!==o.dataset.being?l()||(i=o.dataset.being,n=o.dataset.being?[o]:[]):o.dataset.being&&n.push(o),a===t.colsCount-1&&l()}}return s},deleteGroup(e){game.soundMatch.play();let s=e[0].dataset.being;if(s){t.beingsForWin[s]&&(t.beingsForWin[s]-=e.length,t.beingsForWin[s]=t.beingsForWin[s]<0?0:t.beingsForWin[s],this.updateStatusBar()),t.score+=10*e.length;for(let t of e)t.classList.add("clear"),this.clearCell(t),setTimeout((function(){t.classList.remove("clear")}),600)}},shiftBeings(){for(let e=0;e<t.rowsCount;e++){let s=-1;for(let n=t.colsCount-1;n>=0;n--){let t=this.cells[`x${e}_y${n}`];t.dataset.being||-1!==s?s>-1&&t.dataset.being&&(this.addBeingToCell(t.dataset.being,`x${e}_y${s}`),this.clearCell(t),s--):s=n}}},initStatusBar(){this.movesObj=document.querySelector("#moves-value"),this.scoreObj=document.querySelector("#score-value"),this.gameResultObj=document.querySelector("#game-footer"),this.gameResultObj.innerHTML="Swap animals to form a sequence of three in a row";let e=document.getElementById("beings-for-win");for(let s in t.beingsForWin){let t=document.createElement("span");t.classList.add(s),e.appendChild(t)}this.updateStatusBar()},updateStatusBar(){this.movesObj.innerHTML=t.numberOfMoves,this.scoreObj.innerHTML=t.score;for(let e in t.beingsForWin)document.querySelector("#beings-for-win span."+e).innerHTML=t.beingsForWin[e]}},n={settings:t,map:s,selectedBeing:"",gameOver:!1,soundClick:null,soundMatch:null,init(){this.map.renderMap(this.settings.rowsCount,this.settings.colsCount),this.map.renderBeings(),this.map.initStatusBar(),window.onclick=this.mouseClickHandler,this.soundClick=new e("sounds/click.wav"),this.soundMatch=new e("sounds/match.wav")},mouseClickHandler(e){if(!this.gameOver){let i=e.target;if(i.dataset.coords){if(!n.selectedBeing)return n.soundClick.play(),n.selectedBeing=i,n.map.setSelectedCell(n.selectedBeing.dataset.coords),!0;if(n.isAdjacentCell(n.selectedBeing.dataset.coords,i.dataset.coords)){if(n.soundClick.play(),n.changeBeings(i,n.selectedBeing),n.map.resetCell(n.selectedBeing.dataset.coords),s.checkMatchesInMap())for(s.shiftBeings(),s.renderBeings();s.checkMatchesInMap();)s.shiftBeings(),s.renderBeings();else n.changeBeings(i,n.selectedBeing);if(n.selectedBeing="",t.numberOfMoves--,s.updateStatusBar(),this.isWin())return s.gameResultObj.innerHTML="You won! Reload the page to start the game again.",void(this.gameOver=!0);0===t.numberOfMoves&&(s.gameResultObj.innerHTML="You lost! Reload the page to start the game again.",this.gameOver=!0)}}}},isWin(){let e=0;for(let s in t.beingsForWin)e+=t.beingsForWin[s];return e<=0},isAdjacentCell(e,t){if(e&&t)if(e[1]===t[1]){if(1===Math.abs(e[4]-t[4]))return!0}else if(e[4]===t[4]&&1===Math.abs(e[1]-t[1]))return!0;return!1},changeBeings(e,t){let s=e.src,n=e.parentElement.dataset.being;e.src=t.src,e.parentElement.dataset.being=t.parentElement.dataset.being,t.src=s,t.parentElement.dataset.being=n}};window.onload=function(){n.init()}})();